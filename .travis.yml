language: node_js

node_js:
  - stable

stages:
  - express
  - staging
  - deploy
  - e2e
  - storybook

addons:
  apt:
    packages:
      - libgconf-2-4

git:
  submodules: true

services:
  - postgresql

env:
  - TRAVIS_DATABASE=$TRAVIS_DATABASE

before_script:
  - psql -c 'create database testing;' -U postgres

jobs:
  include:
    - stage: express
      name: "Express Tests"
      script:
        - npm run test
      cache:
        npm: true
      if: (NOT branch = master AND NOT branch = staging AND NOT type = pull_request)
    - stage: express
      name: "Contract tests"
      script:
        - npm run test:pact
      cache:
        npm: true
      if: (NOT branch = master AND NOT branch = staging AND NOT type = pull_request)
    - stage: storybook
      name: "Story book"
      script:
        - npm run storybook
      if: branch = staging
    - stage: e2e
      name: "Cypress tests"
      script:
        - npm run test:ci:e2e
      cache:
        npm: true
        directories:
          - /home/travis/.cache
      if: (branch = staging AND type = pull_request)
    - stage: staging
      name: "Deploy to staging"
      script: skip
      cache:
        npm: true
        directories:
          - /home/travis/.cache
      deploy:
        provider: heroku
        app:
          staging: serene-wave-13524-staging
        api_key:
          secure: "fxK4JxIBgohhVx7iDCwtbdmb0WMp9vwVDPncq4BtVBYU88Ga/GXHpFfjh+P1CvwwqAeL8dh5pvcFfyOdC9f1C5eQKGoAdaRY0AE5mLtgssas2d0tC1q6L67smgH4mBDGZ7r870fSRWVfEGpxwykhQF5OO48f6C6GV0AnOATH8L3Yw07Bu5ZTN9gJ8bF9lJdeYHAFScB+3jbBZMiE+qgSLYHj450duTKcIuO7ibhdaHdYMNXktSVEUd3zaEuN9jVi6Z9MfXRc6PgMZnhBFdLr6dz8zREx2dovr+42Ku5/kYgyA3/RVm4ZujnX3UilbfDQcc2dRU4bSjy4K0X9Hi+p4c7FUKnP0S99wjd6IkEtlLSeEUbDSmSBzyrOwAaNImRlBozhpGC9HnT7vSfk3uQ/ZssBaOlo24HiM+1MRqN5fg+67mQvR+bA0H0MQmiTtv9bv/TeEQgopXQ0iZOnkSPXhdRWoBweAh5PlAtR9QVlv5vCvG72NyPOymgRH7ln+g5NtgrQMdp1b+BatqjpqnlwkKoxy0UDUxpZBSD3BK1vxD7t7b9NpHlHf4fDZAnVv/eX3Y3WFsZJwLF0k4binpb0ZuxnQL2y9FaBjqfRFwETT6beBjPvlVXV+lUqqDSFEVqWdi+BKUPPzT+kjRUmzv/y/NNBU3JgoypmQIh9D+gxjbY="
      if: branch = staging
    - stage: Deploy to Master
      script: skip
      deploy:
        provider: heroku
        app: serene-wave-13524
        api_key:
          secure: "fxK4JxIBgohhVx7iDCwtbdmb0WMp9vwVDPncq4BtVBYU88Ga/GXHpFfjh+P1CvwwqAeL8dh5pvcFfyOdC9f1C5eQKGoAdaRY0AE5mLtgssas2d0tC1q6L67smgH4mBDGZ7r870fSRWVfEGpxwykhQF5OO48f6C6GV0AnOATH8L3Yw07Bu5ZTN9gJ8bF9lJdeYHAFScB+3jbBZMiE+qgSLYHj450duTKcIuO7ibhdaHdYMNXktSVEUd3zaEuN9jVi6Z9MfXRc6PgMZnhBFdLr6dz8zREx2dovr+42Ku5/kYgyA3/RVm4ZujnX3UilbfDQcc2dRU4bSjy4K0X9Hi+p4c7FUKnP0S99wjd6IkEtlLSeEUbDSmSBzyrOwAaNImRlBozhpGC9HnT7vSfk3uQ/ZssBaOlo24HiM+1MRqN5fg+67mQvR+bA0H0MQmiTtv9bv/TeEQgopXQ0iZOnkSPXhdRWoBweAh5PlAtR9QVlv5vCvG72NyPOymgRH7ln+g5NtgrQMdp1b+BatqjpqnlwkKoxy0UDUxpZBSD3BK1vxD7t7b9NpHlHf4fDZAnVv/eX3Y3WFsZJwLF0k4binpb0ZuxnQL2y9FaBjqfRFwETT6beBjPvlVXV+lUqqDSFEVqWdi+BKUPPzT+kjRUmzv/y/NNBU3JgoypmQIh9D+gxjbY="
      if: branch = master
  exclude:
    - stage: staging
      if: type = pull_request
